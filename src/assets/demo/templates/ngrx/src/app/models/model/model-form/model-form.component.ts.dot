import {Component, EventEmitter, Input, OnInit, Output} from '@angular/core';
import {FormBuilder, FormGroup, FormControl, Validators} from '@angular/forms';
import {ErrorService} from '@app/messages';
import {{{=it.m.names.upperCamel}}} from '../{{=it.m.names.hyphen}}';
import {{{=it.m.names.upperCamel}}Service} from '../{{=it.m.names.hyphen}}.service';

@Component({
  selector: 'anms-{{=it.m.names.hyphen}}-form',
  templateUrl: './{{=it.m.names.hyphen}}-form.component.html',
  styleUrls: ['./{{=it.m.names.hyphen}}-form.component.scss']
})
export class {{=it.m.names.upperCamel}}FormComponent implements OnInit {

  /**
   * The {{=it.m.names.wordsLower}} to inject in the form
   */
  @Input() {{=it.m.names.lowerCamel}}: {{=it.m.names.upperCamel}};

  /**
   * Called the save button is clicked for a new instance
   *
   * @type {EventEmitter<{{=it.m.names.upperCamel}}>}
   */
  @Output() onCreate = new EventEmitter<{{=it.m.names.upperCamel}}>();

  /**
   * Called the save button is clicked for an existing instance
   *
   * @type {EventEmitter<{{=it.m.names.upperCamel}}>}
   */
  @Output() onUpdate = new EventEmitter<{{=it.m.names.upperCamel}}>();

  /**
   * @type {FormGroup}
   */
  form: FormGroup;

  /**
   * Constructor
   *
   * @param {FormBuilder} formBuilder
   * @param {ErrorService} errorService
   * @param {{{=it.m.names.upperCamel}}Service} {{=it.m.names.lowerCamel}}Service
   */
  constructor(private formBuilder: FormBuilder,
              private errorService: ErrorService,
              private {{=it.m.names.lowerCamel}}Service: {{=it.m.names.upperCamel}}Service) {
  }

  /**
   * Init
   */
  ngOnInit() {
    // If no instance, create a new one
    if (!this.{{=it.m.names.lowerCamel}}) {
      this.{{=it.m.names.lowerCamel}} = new {{=it.m.names.upperCamel}}();
    }
    // Form validator{{?it.m.f.l.find(f => f.isPrivate && !f.internal)}}
    const privateRequired = this.{{=it.m.names.lowerCamel}}.isNew() ? [Validators.required] : [];{{?}}
    this.form = this.formBuilder.group({{{~it.m.f.l : f}}{{? !f.internal }}
      {{=f.names.underscore}}: new FormControl(this.{{=it.m.names.lowerCamel}}.props.{{=f.names.underscore}}, {{? f.isPrivate }}[].concat(privateRequired){{??}}[Validators.required]{{?}}),{{?}}{{~}}
    });
  }

  /**
   * Called on form submit
   */
  onSubmit(): void {
    // Create payload
    const props = this.{{=it.m.names.lowerCamel}}.toObject();
    const payload = {{{~it.m.f.l : f}}{{? !f.internal }}
      {{=f.names.underscore}}: {{?f.type==='datetime'}}<number>{{?}}props.{{=f.names.underscore}},{{?}}{{~}}
    };
    // Creation or update ?
    if (this.{{=it.m.names.lowerCamel}}.isNew()) {
      // Creation
      this.{{=it.m.names.lowerCamel}}Service.create(payload)
        .then(({{=it.m.names.lowerCamel}}: {{=it.m.names.upperCamel}}) => {
          this.onCreate.next({{=it.m.names.lowerCamel}});
        })
        .catch((error) => this.errorService.handle(error));
    } else {
      // Update
      this.{{=it.m.names.lowerCamel}}Service.update(this.{{=it.m.names.lowerCamel}}.getId(), payload)
        .then(() => {
          this.onUpdate.next(this.{{=it.m.names.lowerCamel}});
        })
        .catch((error) => this.errorService.handle(error));
    }
  }

}
